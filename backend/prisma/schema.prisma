generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeviceStatus {
  ACQUIRED
  QC_PENDING
  QC_PASSED
  PRICED
  IN_STOCK
  REFURB_PENDING
  REFURB_IN_PROGRESS
  REFURB_DONE
  RECHECK_PENDING
  LISTED
  RESERVED
  SOLD
  AFTERSALE
  RETURNED
  SCRAPPED
  TRANSFER_IN_TRANSIT
  LOST
}

enum RefurbStatus {
  CREATED
  ASSIGNED
  IN_PROGRESS
  WAIT_PARTS
  DONE
  CANCELLED
}

enum InventoryTxType {
  INBOUND
  OUTBOUND
  TRANSFER
  STOCKTAKE
}

enum PurchaseStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum TransferStatus {
  CREATED
  SHIPPED
  RECEIVED
  CANCELLED
}

enum SalesStatus {
  CREATED
  PAID
  CANCELLED
  REFUNDED
}

enum AfterSaleStatus {
  CREATED
  IN_PROGRESS
  DONE
  CANCELLED
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  stores    Store[]
  users     User[]
}

model Store {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  warehouses Warehouse[]
}

model Warehouse {
  id        String   @id @default(cuid())
  tenantId  String
  storeId   String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  store     Store    @relation(fields: [storeId], references: [id])
  devices   Device[]
}

model User {
  id        String   @id @default(cuid())
  tenantId  String
  username  String   @unique
  password  String
  roleId    String
  storeId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  role      Role     @relation(fields: [roleId], references: [id])
}

model Role {
  id          String       @id @default(cuid())
  tenantId    String
  name        String
  permissions Permission[] @relation("RolePermissions")
}

model Permission {
  id    String  @id @default(cuid())
  code  String  @unique
  name  String
  roles Role[]  @relation("RolePermissions")
}

model Sku {
  id        String   @id @default(cuid())
  tenantId  String
  brand     String
  model     String
  color     String
  storage   String
  network   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Device {
  id           String      @id @default(cuid())
  tenantId     String
  skuId        String
  storeId      String
  warehouseId  String
  imei         String
  imei2        String?
  serial       String?
  status       DeviceStatus
  currentCost  Float       @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime?
  sku          Sku         @relation(fields: [skuId], references: [id])
  warehouse    Warehouse   @relation(fields: [warehouseId], references: [id])
  inspections  InspectionRecord[]
  refurbOrders RefurbOrder[]
  inventoryTxs InventoryTx[]

  @@index([imei])
  @@index([serial])
}

model InspectionTemplate {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     InspectionTemplateItem[]
}

model InspectionTemplateItem {
  id          String   @id @default(cuid())
  templateId  String
  label       String
  template    InspectionTemplate @relation(fields: [templateId], references: [id])
}

model InspectionRecord {
  id         String   @id @default(cuid())
  tenantId   String
  deviceId   String
  grade      String
  defects    String[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  device     Device   @relation(fields: [deviceId], references: [id])
  results    InspectionItemResult[]
}

model InspectionItemResult {
  id           String   @id @default(cuid())
  recordId     String
  label        String
  result       String
  note         String?
  record       InspectionRecord @relation(fields: [recordId], references: [id])
}

model RefurbOrder {
  id         String       @id @default(cuid())
  tenantId   String
  deviceId   String
  status     RefurbStatus
  content    String
  laborCost  Float       @default(0)
  partsCost  Float       @default(0)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  device     Device      @relation(fields: [deviceId], references: [id])
}

model PurchaseOrder {
  id         String        @id @default(cuid())
  tenantId   String
  code       String        @unique
  status     PurchaseStatus
  totalPrice Float
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  items      PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id            String   @id @default(cuid())
  purchaseId    String
  deviceId      String
  purchaseOrder PurchaseOrder @relation(fields: [purchaseId], references: [id])
}

model TransferOrder {
  id         String         @id @default(cuid())
  tenantId   String
  code       String         @unique
  status     TransferStatus
  fromWarehouseId String
  toWarehouseId   String
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model SalesOrder {
  id         String     @id @default(cuid())
  tenantId   String
  code       String     @unique
  status     SalesStatus
  totalPrice Float
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  items      SalesOrderItem[]
}

model SalesOrderItem {
  id        String   @id @default(cuid())
  salesId   String
  deviceId  String
  sales     SalesOrder @relation(fields: [salesId], references: [id])
}

model AfterSale {
  id         String        @id @default(cuid())
  tenantId   String
  code       String        @unique
  status     AfterSaleStatus
  deviceId   String
  reason     String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

model InventoryTx {
  id          String          @id @default(cuid())
  tenantId    String
  deviceId    String
  warehouseId String
  type        InventoryTxType
  quantity    Int             @default(1)
  createdAt   DateTime        @default(now())

  @@index([deviceId, warehouseId, createdAt])
}

model Cashflow {
  id        String   @id @default(cuid())
  tenantId  String
  type      String
  amount    Float
  note      String?
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  action    String
  detail    String
  createdAt DateTime @default(now())
}
